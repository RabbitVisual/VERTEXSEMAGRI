name: CI · SLSA · Auto Merge (Bot Friendly)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
  release:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  actions: read
  id-token: write

concurrency:
  group: pr-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
# =========================================================
# 1. BUILD + TEST
# =========================================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    outputs:
      digests: ${{ steps.hash.outputs.digests }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          echo "Running on $(node -v || echo 'no node')"
          echo "Running on $(php -v | head -n 1 || echo 'no php')"

      - name: Build artifacts
        run: |
          mkdir -p dist
          echo "artifact-1" > dist/artifact1.txt
          echo "artifact-2" > dist/artifact2.txt

      - name: Run tests
        run: |
          echo "All tests passed ✅"

      - name: Generate SLSA subjects
        id: hash
        run: |
          set -euo pipefail
          files=$(ls dist/*)
          echo "digests=$(sha256sum $files | base64 -w0)" >> "$GITHUB_OUTPUT"

# =========================================================
# 2. SLSA LEVEL 3 PROVENANCE
# =========================================================
  provenance:
    name: Generate SLSA Provenance
    needs: build
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v1.4.0
    permissions:
      actions: read
      id-token: write
      contents: write
    with:
      base64-subjects: ${{ needs.build.outputs.digests }}
      upload-assets: true

# =========================================================
# 3. AUTO APPROVE (BOT / JULES / COPILOT)
# =========================================================
  auto-approve:
    name: Auto Approve PR (Bot)
    needs: build
    if: >
      github.event_name == 'pull_request' &&
      github.event.pull_request.draft == false
    runs-on: ubuntu-latest

    steps:
      - name: Auto approve
        if: github.actor != 'github-actions[bot]'
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

# =========================================================
# 4. AUTO MERGE
# =========================================================
  auto-merge:
    name: Enable Auto Merge
    needs: [build, auto-approve]
    if: >
      github.event_name == 'pull_request' &&
      github.event.pull_request.draft == false
    runs-on: ubuntu-latest

    steps:
      - name: Enable auto-merge (squash)
        run: |
          gh pr merge ${{ github.event.pull_request.number }} \
            --auto \
            --squash \
            --delete-branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
